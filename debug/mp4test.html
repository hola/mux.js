<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width">

  <link rel="stylesheet" href="css/normalize.min.css">
  <link rel="stylesheet" href="css/main.css">

  <script src="js/vendor/modernizr-2.6.2.min.js"></script>
  <style>
    fieldset {
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <!--[if lt IE 7]>
      <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
      <![endif]-->

  <div class="header-container">
    <header class="wrapper clearfix">
      <h1 class="title">MP4 transmux</h1>
    </header>
  </div>

  <div class="main-container">
    <div class="main wrapper clearfix">

      <article>
        <header>
          <p>
            This page can help you check the results of the
            transmuxing MP4 to fMP4 files.
          </p>
        </header>
        <section>
          <h2>Inputs</h2>
          <form id="inputs">
            <legend>
              The input with the checked radio box will be loaded into
              the player on this page.
            </legend>
            <fieldset>
              <legend>MP4 Input</legend>
              <div>
                <input id="original-active" type=radio name=active checked value="original">
                <label>
                  Your original MP4:
                  <input type="file" id="original">
                </label>
              </div>
              <div>
                <label><input id="combined-output" type=checkbox name=combined checked value="combined">&nbsp;Remux output into a single output?
                </label>
              </div>
              <div>
                Otherwise, output only:&nbsp;
                <label><input id="video-output" type=radio name=output disabled checked value="video">&nbsp;Video
                </label>
                <label><input id="audio-output" type=radio name=output disabled checked value="audio">&nbsp;Audio
                </label>
              </div>
            </fieldset>
            <div>
              <label>
                Codecs:
                <input id="codecs" type="text" value="avc1.64001f,mp4a.40.5">
              </label>
            </div>
          </form>
        </section>
        <section id="video-place">
        </section>
     </article>

    </div> <!-- #main -->
  </div> <!-- #main-container -->

  <div class="footer-container">
    <footer class="wrapper">
      <h3>footer</h3>
    </footer>
  </div>


  <script src="../lib/stream.js"></script>
  <script src="../lib/exp-golomb.js"></script>
  <script src="../lib/mp4-generator.js"></script>
  <script src="../lib/mp4parser.js"></script>
  <script src="../lib/mp4-inspector.js"></script>
  <script src="../lib/transmuxer.js"></script>

  <!-- Include QUnit for object diffs -->
  <script src="../node_modules/qunitjs/qunit/qunit.js"></script>
  <script>
    'use strict';
    var inputs = document.getElementById('inputs'),
        original = document.getElementById('original'),
        working = document.getElementById('working'),

        vjsParsed,
        workingParsed,
        diffParsed,
        vjsBytes,
        workingBytes,
        saveConfig,
        restoreConfig,

        vjsBoxes = document.querySelector('.vjs-boxes'),
        workingBoxes = document.querySelector('.working-boxes'),

        video,
        mediaSource,
        logevent,
        prepareSourceBuffer;

        logevent = function(event) {
          console.log(event.type);
        };

    saveConfig = function () {
      var inputs = [].slice.call(document.querySelectorAll('input:not([type=file])'));

      inputs.forEach(function (element) {
        localStorage.setItem(element.id,
          JSON.stringify({
          value: element.value,
          checked: element.checked,
          disabled: element.disabled
        }));
      });
    };

    restoreConfig = function () {
      var inputs = [].slice.call(document.querySelectorAll('input:not([type=file])'));

      inputs.forEach(function (element) {
        var state;

        state = JSON.parse(localStorage.getItem(element.id));
        if (state) {
          element.checked = state.checked;
          element.value = state.value;
          element.disabled = state.disabled;
        }
      });
    };
    document.addEventListener('DOMContentLoaded', restoreConfig);

    // output a diff of the two parsed MP4s
    diffParsed = function() {
      var comparison, diff, transmuxed;
      if (!vjsParsed || !workingParsed) {
        // wait until both inputs have been provided
        return;
      }
      comparison = document.querySelector('#comparison');
      transmuxed = vjsParsed;
      diff = '<p>A <del>red background</del> indicates ' +
        'properties present in the transmuxed file but missing from the ' +
        'working version. A <ins>green background</ins> indicates ' +
        'properties present in the working version but missing in the ' +
        'transmuxed output.</p>';
      diff += '<pre class="mp4-diff">' +
        QUnit.diff(muxjs.textifyMp4(transmuxed, null, ' '),
                   muxjs.textifyMp4(workingParsed, null, ' ')) +
        '</pre>';

      comparison.innerHTML = diff;
    };

    prepareSourceBuffer = function(combined, outputType, callback) {
      var
        buffer,
        codecs,
        codecsArray;

      if (typeof combined === 'function') {
        callback = combined;
        combined = true;
      }

      video = document.createElement('video');
      video.controls = true;
      mediaSource = new MediaSource();
      video.src = URL.createObjectURL(mediaSource);
      window.vjsVideo = video;
      window.vjsMediaSource = mediaSource;
      document.querySelector('#video-place').innerHTML = '';
      document.querySelector('#video-place').appendChild(video);

      mediaSource.addEventListener('error', logevent);
      mediaSource.addEventListener('opened', logevent);
      mediaSource.addEventListener('closed', logevent);
      mediaSource.addEventListener('sourceended', logevent);
      mediaSource.addEventListener('sourceopen', logevent);

      codecs = document.querySelector('#codecs');
      codecsArray = codecs.value.split(',');

      mediaSource.addEventListener('sourceopen', function () {
        if (combined) {
          buffer = mediaSource.addSourceBuffer('video/mp4;codecs="' + codecs.value + '"');
        } else if (outputType === 'video') {
          buffer = mediaSource.addSourceBuffer('video/mp4;codecs="' + codecsArray[0] + '"');
        } else if (outputType === 'audio') {
          buffer = mediaSource.addSourceBuffer('audio/mp4;codecs="' + (codecsArray[1] ||codecsArray[0]) + '"');
        }

        buffer.addEventListener('updatestart', logevent);
        buffer.addEventListener('updateend', logevent);
        buffer.addEventListener('error', logevent);
        window.vjsBuffer = buffer;

        video.addEventListener('error', logevent);
        video.addEventListener('error', function() {
          document.getElementById('video-place').classList.add('error');
        });
        console.log('buffer created');
        video.play();
        return callback();
      });
    };

    original.addEventListener('change', function() {
      var reader = new FileReader();

      // do nothing if no file was chosen
      if (!this.files[0]) {
        return;
      }

      reader.addEventListener('loadend', function() {
        var segment = new Uint8Array(reader.result),
            combined = document.querySelector('#combined-output').checked,
            outputType = document.querySelector('input[name="output"]:checked').value,
            transmuxer,
            remuxedSegments = [],
            remuxedBytesLength = 0,
            bytes,
            workingParsed,
            i, j, chunk_size = 65536,
            inited = false, u_ind = 0;

        workingParsed = muxjs.inspectMp4(segment);
        console.log('working', workingParsed);

        if (combined) {
            transmuxer = new muxjs.mp2t.Transmuxer({
                input_type: 'mp4',
                no_multi_init: 1,
            });
        } else {
            transmuxer = new muxjs.mp2t.Transmuxer({
                input_type: 'mp4',
                remux: false,
                no_multi_init: 1,
            });
        }

        function processFile()
        {
          window.vjsBuffer.addEventListener('updateend', pushSegment);
          var pos = 0, cnt = 0;
          while (pos!=segment.length)
          {
            pos = transmuxer.push(segment.subarray(pos,
              Math.min(pos+chunk_size, segment.length)));
          }
          transmuxer.flush();
          bytes = new Uint8Array(remuxedBytesLength);
          for (j = 0, i = 0; j < remuxedSegments.length; j++) {
            bytes.set(remuxedSegments[j].data, i);
            i += remuxedSegments[j].data.byteLength;
          }
          var a = document.createElement("a");
          var file = new Blob([bytes], {type: 'video/mp4'});
          a.href = URL.createObjectURL(file);
          a.download = 'result.mp4';
          a.click();
          vjsBytes = bytes;
          vjsParsed = muxjs.inspectMp4(bytes);
          console.log('transmuxed', vjsParsed);
          diffParsed();
        }

        function pushSegment()
        {
          if (remuxedSegments[u_ind])
            window.vjsBuffer.appendBuffer(remuxedSegments[u_ind++].data);
        }

        if (document.querySelector('#original-active').checked) {
          prepareSourceBuffer(combined, outputType, function () {
            processFile();
          });
        }

        transmuxer.on('data', function(segment) {
          if (segment.init)
          {
            if (inited)
              return;
            inited = true;
          }
          if (combined || segment.type === outputType) {
            remuxedSegments.push(segment);
            remuxedBytesLength += segment.data.byteLength;
            if (!window.vjsBuffer.updating)
              pushSegment();
          }
        });

       });
      reader.readAsArrayBuffer(this.files[0]);
    }, false);

    document.querySelector('#combined-output').addEventListener('change', function () {
        Array.prototype.slice.call(document.querySelectorAll('[name="output"'))
          .forEach(function (el) {
            el.disabled = this.checked;
          }, this);
    });

    [].slice.call(document.querySelectorAll('input')).forEach(function(el){
      el.addEventListener('change', saveConfig);
    });
  </script>
</body>
</html>
